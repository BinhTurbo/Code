# üß™ Test API - Redis & RabbitMQ

## üîß Setup

Tr∆∞·ªõc khi test, ch·∫°y c√°c l·ªánh sau:

```bash
# 1. Kh·ªüi ƒë·ªông Docker services
cd d:\Code
docker-compose up -d

# 2. Ch·∫°y backend
cd backend\miniweb
mvnw spring-boot:run

# 3. Ki·ªÉm tra services
# MySQL: localhost:3306
# Redis: localhost:6379
# RabbitMQ: localhost:5672
# RabbitMQ UI: http://localhost:15672 (admin/admin123)
```

---

## üìã Test Cases

### 1Ô∏è‚É£ Test Redis Cache - Product

#### Test Case 1.1: Cache Miss (L·∫ßn ƒë·∫ßu query)

**Request:**

```http
GET http://localhost:8081/api/products?q=laptop&status=ACTIVE&page=0&size=10
Content-Type: application/json
```

**Expected:**

- Response time: ~100ms (query DB)
- Log backend:

```
Hibernate: SELECT ... FROM products WHERE ...
```

**Verify in Redis:**

```bash
docker exec -it wedmini-redis redis-cli
> KEYS products::*
# Output: "products::laptop_null_null_ACTIVE_null_0_10"
```

---

#### Test Case 1.2: Cache Hit (L·∫ßn th·ª© 2 query c√πng ƒëi·ªÅu ki·ªán)

**Request:**

```http
GET http://localhost:8081/api/products?q=laptop&status=ACTIVE&page=0&size=10
Content-Type: application/json
```

**Expected:**

- Response time: ~5ms (l·∫•y t·ª´ cache)
- KH√îNG c√≥ log Hibernate query
- Data gi·ªëng v·ªõi l·∫ßn 1

---

#### Test Case 1.3: Cache Eviction (T·∫°o product m·ªõi)

**Request:**

```http
POST http://localhost:8081/api/products
Content-Type: application/json
Authorization: Bearer <your-jwt-token>

{
  "sku": "SKU001",
  "name": "Laptop Dell XPS 13",
  "categoryId": 1,
  "price": 25000000,
  "stock": 10,
  "status": "ACTIVE"
}
```

**Expected:**

- Status: 200 OK
- Product ƒë∆∞·ª£c t·∫°o
- Cache product b·ªã x√≥a

**Verify:**

```bash
docker exec -it wedmini-redis redis-cli
> KEYS products::*
# Output: (empty array) - Cache ƒë√£ b·ªã x√≥a
```

**Re-test Cache:**

```http
GET http://localhost:8081/api/products?q=laptop&status=ACTIVE&page=0&size=10
# L·∫ßn n√†y s·∫Ω query DB l·∫°i (cache miss)
```

---

### 2Ô∏è‚É£ Test Redis Cache - Category

#### Test Case 2.1: Get Category by ID (Cache)

**Request:**

```http
GET http://localhost:8081/api/categories/1
Content-Type: application/json
```

**Expected (L·∫ßn 1):**

- Response time: ~50ms (query DB)
- Data returned

**Expected (L·∫ßn 2):**

- Response time: ~3ms (cache hit)
- Data gi·ªëng l·∫ßn 1

**Verify:**

```bash
docker exec -it wedmini-redis redis-cli
> GET "categories::1"
# Output: JSON c·ªßa category
```

---

### 3Ô∏è‚É£ Test RabbitMQ - Category Created Event

#### Test Case 3.1: T·∫°o Category M·ªõi

**Request:**

```http
POST http://localhost:8081/api/categories
Content-Type: application/json
Authorization: Bearer <your-jwt-token>

{
  "name": "ƒêi·ªán tho·∫°i",
  "status": "ACTIVE"
}
```

**Expected Backend Log:**

```
üì§ ƒê√£ g·ª≠i message: Category created - ID: 1, Name: ƒêi·ªán tho·∫°i
üì• Nh·∫≠n message: CategoryEventMessage(categoryId=1, categoryName=ƒêi·ªán tho·∫°i, ...)
üéâ X·ª≠ l√Ω event: Category created - ƒêi·ªán tho·∫°i
‚úÖ ƒê√£ g·ª≠i email ƒë·∫øn: admin@example.com
```

**Verify RabbitMQ:**

1. M·ªü http://localhost:15672
2. Login: admin/admin123
3. Tab **Queues** ‚Üí Click `category.queue`
4. Xem section **Message rates**:
   - **Publish**: 1 message
   - **Deliver**: 1 message
   - **Ack**: 1 message

**Verify Email (n·∫øu ƒë√£ config):**

- Check email `admin@example.com`
- Subject: "üéâ Danh m·ª•c m·ªõi ƒë∆∞·ª£c t·∫°o: ƒêi·ªán tho·∫°i"

---

### 4Ô∏è‚É£ Test RabbitMQ - Category Status Changed Event

#### Setup: T·∫°o category v√† products

**Step 1: T·∫°o Category**

```http
POST http://localhost:8081/api/categories
Content-Type: application/json
Authorization: Bearer <your-jwt-token>

{
  "name": "Laptop Gaming",
  "status": "ACTIVE"
}

# Response: {id: 1, name: "Laptop Gaming", status: "ACTIVE"}
```

**Step 2: T·∫°o 3 Products thu·ªôc Category n√†y**

```http
POST http://localhost:8081/api/products
Content-Type: application/json
Authorization: Bearer <your-jwt-token>

{
  "sku": "LAPTOP-001",
  "name": "Asus ROG",
  "categoryId": 1,
  "price": 30000000,
  "stock": 5,
  "status": "ACTIVE"
}

# Repeat 2 l·∫ßn n·ªØa v·ªõi SKU kh√°c: LAPTOP-002, LAPTOP-003
```

**Step 3: Verify tr∆∞·ªõc khi test**

```sql
-- V√†o MySQL
SELECT * FROM categories WHERE id = 1;
-- status = ACTIVE

SELECT * FROM products WHERE category_id = 1;
-- C√≥ 3 products, t·∫•t c·∫£ status = ACTIVE
```

---

#### Test Case 4.1: S·ª≠a Status Category ACTIVE ‚Üí INACTIVE

**Request:**

```http
PUT http://localhost:8081/api/categories/1
Content-Type: application/json
Authorization: Bearer <your-jwt-token>

{
  "name": "Laptop Gaming",
  "status": "INACTIVE"
}
```

**Expected Backend Log:**

```
üì§ ƒê√£ g·ª≠i message: Category status changed - ID: 1, ACTIVE -> INACTIVE
üì• Nh·∫≠n message: CategoryEventMessage(...)
üîÑ X·ª≠ l√Ω event: Category status changed - Laptop Gaming (ACTIVE -> INACTIVE)
‚úÖ ƒê√£ c·∫≠p nh·∫≠t 3 s·∫£n ph·∫©m sang INACTIVE
‚úÖ ƒê√£ g·ª≠i email ƒë·∫øn: admin@example.com
```

**Verify Database:**

```sql
-- Category status ƒë√£ thay ƒë·ªïi
SELECT * FROM categories WHERE id = 1;
-- status = INACTIVE

-- T·∫§T C·∫¢ products thu·ªôc category c≈©ng INACTIVE
SELECT * FROM products WHERE category_id = 1;
-- C·∫£ 3 products ƒë·ªÅu status = INACTIVE
```

**Verify RabbitMQ:**

- Tab **Queues** ‚Üí `category.queue`
- Message rates: Publish +1, Deliver +1, Ack +1

**Verify Cache:**

```bash
docker exec -it wedmini-redis redis-cli
> KEYS categories::*
# Empty - Cache category ƒë√£ x√≥a

> KEYS products::*
# Empty - Cache product ƒë√£ x√≥a (do listener g·ªçi @CacheEvict)
```

**Verify Email:**

- Subject: "üîÑ Tr·∫°ng th√°i danh m·ª•c thay ƒë·ªïi: Laptop Gaming"
- Body ch·ª©a:
  - Tr·∫°ng th√°i c≈©: ACTIVE
  - Tr·∫°ng th√°i m·ªõi: INACTIVE
  - S·ªë s·∫£n ph·∫©m b·ªã ·∫£nh h∆∞·ªüng: 3

---

#### Test Case 4.2: S·ª≠a Status Category INACTIVE ‚Üí ACTIVE

**Request:**

```http
PUT http://localhost:8081/api/categories/1
Content-Type: application/json
Authorization: Bearer <your-jwt-token>

{
  "name": "Laptop Gaming",
  "status": "ACTIVE"
}
```

**Expected:**

- Category status ‚Üí ACTIVE
- Message g·ª≠i v√†o RabbitMQ
- Email g·ª≠i th√¥ng b√°o
- **Products KH√îNG t·ª± ƒë·ªông chuy·ªÉn v·ªÅ ACTIVE** (ch·ªâ √°p d·ª•ng cho INACTIVE)

**Verify:**

```sql
SELECT * FROM categories WHERE id = 1;
-- status = ACTIVE

SELECT * FROM products WHERE category_id = 1;
-- V·∫´n INACTIVE (kh√¥ng auto-activate)
```

---

### 5Ô∏è‚É£ Test Performance - Cache vs No Cache

#### Test Case 5.1: Benchmark Cache Performance

**Tool:** S·ª≠ d·ª•ng cURL ho·∫∑c Postman

**Without Cache (L·∫ßn ƒë·∫ßu):**

```bash
# X√≥a cache tr∆∞·ªõc
docker exec -it wedmini-redis redis-cli FLUSHALL

# ƒêo th·ªùi gian
curl -w "\nTime: %{time_total}s\n" \
  "http://localhost:8081/api/products?q=&page=0&size=100"

# Expected: ~100-200ms (query DB v·ªõi 100 records)
```

**With Cache (L·∫ßn 2):**

```bash
# G·ªçi l·∫°i c√πng request
curl -w "\nTime: %{time_total}s\n" \
  "http://localhost:8081/api/products?q=&page=0&size=100"

# Expected: ~5-10ms (t·ª´ Redis cache)
```

**Performance Gain:**

```
Improvement = (200ms - 10ms) / 200ms * 100% = 95% faster!
```

---

### 6Ô∏è‚É£ Test RabbitMQ Dead Letter Queue (Advanced)

#### Test Case 6.1: Simulate Message Processing Failure

**Setup:** T·∫°m th·ªùi throw exception trong listener

**File:** `CategoryEventListener.java`

```java
@RabbitListener(queues = RabbitMQConfig.CATEGORY_QUEUE)
public void handleCategoryEvent(CategoryEventMessage message) {
    log.info("üì• Nh·∫≠n message: {}", message);

    // ‚ö†Ô∏è TEST: Throw exception ƒë·ªÉ simulate failure
    if (message.getCategoryName().contains("Test")) {
        throw new RuntimeException("Simulate failure for testing");
    }

    // Normal processing...
}
```

**Request:**

```http
POST http://localhost:8081/api/categories
Content-Type: application/json

{
  "name": "Test Category",
  "status": "ACTIVE"
}
```

**Expected:**

- Category ƒë∆∞·ª£c t·∫°o
- Message g·ª≠i v√†o queue
- Listener nh·∫≠n message ‚Üí throw exception
- RabbitMQ retry message (default: infinite retry)

**Verify RabbitMQ:**

- Tab **Queues** ‚Üí `category.queue`
- **Message rates**: Redeliver rate tƒÉng l√™n (message b·ªã retry)

**Fix:** Remove exception trong code v√† restart app

- Message s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω th√†nh c√¥ng

---

### 7Ô∏è‚É£ Monitor Tools

#### Monitor Redis

**Real-time commands:**

```bash
docker exec -it wedmini-redis redis-cli MONITOR
# Xem t·∫•t c·∫£ commands ƒë∆∞·ª£c execute trong Redis
```

**Info:**

```bash
docker exec -it wedmini-redis redis-cli INFO
# Xem stats: memory, clients, keyspace, etc.
```

**Keys:**

```bash
docker exec -it wedmini-redis redis-cli KEYS "*"
# List t·∫•t c·∫£ keys
```

---

#### Monitor RabbitMQ

**Web UI:** http://localhost:15672

**Tabs quan tr·ªçng:**

1. **Overview**: T·ªïng quan message rates
2. **Connections**: Active connections t·ª´ app
3. **Channels**: Channels ƒëang m·ªü
4. **Queues**: Chi ti·∫øt t·ª´ng queue
   - Ready: Message ch∆∞a consume
   - Unacked: Message ƒëang process
   - Total: T·ªïng message
5. **Exchanges**: Routing rules

---

## üéØ Expected Results Summary

| Test Case               | Expected Result                            |
| ----------------------- | ------------------------------------------ |
| Cache Miss              | Query DB, response ~100ms                  |
| Cache Hit               | From Redis, response ~5ms                  |
| Cache Evict             | Cache cleared after create/update          |
| Category Created        | Message ‚Üí Queue ‚Üí Email sent               |
| Category Status Changed | Message ‚Üí Queue ‚Üí Products updated + Email |
| Performance             | 95% faster with cache                      |

---

## üêõ Common Issues

### Issue 1: Email kh√¥ng g·ª≠i ƒë∆∞·ª£c

```
‚ùå L·ªói khi g·ª≠i email ƒë·∫øn admin@example.com
```

**Solution:**

- Check `application.properties` email config
- D√πng Gmail App Password
- Ho·∫∑c comment code g·ª≠i email ƒë·ªÉ test c√°c t√≠nh nƒÉng kh√°c

---

### Issue 2: Cache kh√¥ng ho·∫°t ƒë·ªông

```
# V·∫´n th·∫•y log Hibernate query m·∫∑c d√π ƒë√£ query l·∫ßn 2
```

**Solution:**

```bash
# Check Redis ƒëang ch·∫°y
docker ps | grep redis

# Test Redis connection
docker exec -it wedmini-redis redis-cli ping
# Expected: PONG

# Check cache config
# File: RedisConfig.java ph·∫£i c√≥ @EnableCaching
```

---

### Issue 3: Message kh√¥ng ƒë∆∞·ª£c consume

```
# Message v√†o queue nh∆∞ng listener kh√¥ng x·ª≠ l√Ω
```

**Solution:**

```bash
# Check RabbitMQ connection
docker logs wedmini-rabbitmq

# Check listener c√≥ @RabbitListener annotation
# Check queue name ƒë√∫ng: RabbitMQConfig.CATEGORY_QUEUE
```

---

## üìä Test Report Template

```
Date: ___________
Tester: __________

| Test Case | Status | Time | Notes |
|-----------|--------|------|-------|
| Cache Miss | ‚úÖ | 120ms | OK |
| Cache Hit | ‚úÖ | 8ms | 93% faster |
| Create Category | ‚úÖ | - | Email sent |
| Status Changed | ‚úÖ | - | 3 products updated |

Issues Found:
- None

Overall: PASS ‚úÖ
```

---

Happy Testing! üß™üöÄ
